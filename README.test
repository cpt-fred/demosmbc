==================================================================================
Prepare VM Linux to be iSCSI Ready
===================================================================================
[root@centos1 data]# yum install sshpass -y
[root@centos1 ~]# cat /etc/redhat-release
CentOS Linux release 7.9.2009 (Core)
[root@centos1 ~]# yum install tuned -y
[root@centos1 ~]# yum install device-mapper -y
[root@centos1 ~]# yum install device-mapper-multipath -y
[root@centos1 ~]# tuned-adm profile virtual-guest (VM) -y
[root@centos1 ~]# cat /etc/iscsi/initiatorname.iscsi
InitiatorName=iqn.1994-05.com.redhat:centos1.demo.netapp.com
[root@centos1 ~]# vi /etc/iscsi/iscsid.conf
....
node.session.timeo.replacement_timeout = 5
....

[root@centos1 ~]# systemctl start iscsid

[root@centos1 grub]# cat /proc/cmdline
BOOT_IMAGE=/vmlinuz-3.10.0-1160.6.1.el7.x86_64 root=/dev/mapper/centos-root ro crashkernel=auto spectre_v2=retpoline rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet LANG=en_US.UTF-8

[root@centos1 grub]# grubby --info=ALL |grep vmlinuz
kernel=/boot/vmlinuz-3.10.0-1160.6.1.el7.x86_64
kernel=/boot/vmlinuz-3.10.0-1062.el7.x86_64
kernel=/boot/vmlinuz-0-rescue-3dd62af04f1c432d8f2ef696486639d8


[root@centos1 grub]# grubby --args "rdloaddriver=scsi_dh_alua" --update-kernel /boot/vmlinuz-3.10.0-1160.6.1.el7.x86_64
[root@centos1 ~]# reboot 

[root@centos1 ~]# cat /proc/cmdline
BOOT_IMAGE=/vmlinuz-3.10.0-1160.6.1.el7.x86_64 root=/dev/mapper/centos-root ro crashkernel=auto spectre_v2=retpoline rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet LANG=en_US.UTF-8 rdloaddriver=scsi_dh_alua


[root@centos1 ~]# multipath -t
defaults {
        verbosity 2
        polling_interval 5
        max_polling_interval 20
        reassign_maps "yes"
        multipath_dir "/lib64/multipath"
        path_selector "service-time 0"
        path_grouping_policy "failover"
        uid_attribute "ID_SERIAL"
        prio "const"
        prio_args ""
        features "0"
        path_checker "directio"
        alias_prefix "mpath"
        failback "manual"
        rr_min_io 1000
        rr_min_io_rq 1
        max_fds 1048576
        rr_weight "uniform"
        queue_without_daemon "no"
        flush_on_last_del "no"
        user_friendly_names "no"
        fast_io_fail_tmo 5
        bindings_file "/etc/multipath/bindings"
        wwids_file /etc/multipath/wwids
        prkeys_file /etc/multipath/prkeys
        log_checker_err always
        find_multipaths no
        retain_attached_hw_handler no
        detect_prio no
        detect_path_checker no
        hw_str_match no
        force_sync no
        deferred_remove no
        ignore_new_boot_devs no
        skip_kpartx no
        config_dir "/etc/multipath/conf.d"
        delay_watch_checks no
        delay_wait_checks no
        retrigger_tries 3
        retrigger_delay 10
        missing_uev_wait_timeout 30
        new_bindings_in_boot no
        remove_retries 0
        disable_changed_wwids no
        unpriv_sgio no
        ghost_delay no
        all_tg_pt no
        marginal_path_err_sample_time no
        marginal_path_err_rate_threshold no
        marginal_path_err_recheck_gap_time no
        marginal_path_double_failed_time no
}
blacklist {
        devnode "^(ram|raw|loop|fd|md|dm-|sr|scd|st)[0-9]*"
        devnode "^hd[a-z]"
        devnode "^cciss.*"
        devnode "^(ram|raw|loop|fd|md|dm-|sr|scd|st)[0-9]*"
        devnode "^(td|hd|vd)[a-z]"
        devnode "^dcssblk[0-9]*"
        wwid "3600508e000000000753250f933cc4606"
...
...
...
multipaths {
}

==================================================================================
Install NetApp Linux HUK
==================================================================================
[root@centos1 ~]# rpm -i /tmp/netapp_linux_unified_host_utilities-7-1.x86_64.rpm


==================================================================================
CRATE SAN iSCSI VSERVER
==================================================================================

cluster1::> vserver iscsi show
           Target                           Target                       Status
Vserver    Name                             Alias                        Admin
---------- -------------------------------- ---------------------------- ------
SVM_SAN    iqn.1992-08.com.netapp:sn.5ec3c0ce3fab11eb8f0c005056b0a146:vs.3
                                            SVM_SAN                      up

cluster1::> network interface show -vserver SVM_SAN
            Logical    Status     Network            Current       Current Is
Vserver     Interface  Admin/Oper Address/Mask       Node          Port    Home
----------- ---------- ---------- ------------------ ------------- ------- ----
SVM_SAN
            lif_SVM_SAN_237
                         up/up    192.168.0.130/24   cluster1-01   e0g     true
            lif_SVM_SAN_757
                         up/up    192.168.0.134/24   cluster1-02   e0g     true
            lif_SVM_SAN_816
                         up/up    192.168.0.132/24   cluster1-01   e0g     true
            lif_SVM_SAN_941
                         up/up    192.168.0.131/24   cluster1-01   e0g     true
            lif_SVM_SAN_982
                         up/up    192.168.0.133/24   cluster1-02   e0g     true
5 entries were displayed.



==================================================================================
Create ONTAP LUN
==================================================================================

cluster1::> lun mapping show
Vserver    Path                                      Igroup   LUN ID  Protocol
---------- ----------------------------------------  -------  ------  --------
SVM_SAN    /vol/LUN01/LUN01                          LUN01_16Dec20_foh8_igroup
                                                                   0  mixed

cluster1::> igroup show -vserver SVM_SAN -igroup LUN01_16Dec20_foh8_igroup
          Vserver Name: SVM_SAN
           Igroup Name: LUN01_16Dec20_foh8_igroup
              Protocol: mixed
               OS Type: linux
Portset Binding Igroup: -
           Igroup UUID: 914982f1-3fb5-11eb-8f0c-005056b0a146
                  ALUA: true
            Initiators: iqn.1994-05.com.redhat:centos1.demo.netapp.com (not logged in)


cluster1::*> lun show /vol/LUN01/LUN01 -fields serial-hex
vserver path             serial-hex
------- ---------------- ------------------------
SVM_SAN /vol/LUN01/LUN01 774f6a374d5d51504b697163


==================================================================================
From LINUX iSCSI TARGET Discover
==================================================================================
[root@centos1 ~]# iscsiadm --mode discovery --op update --type sendtargets --portal  192.168.0.131
192.168.0.131:3260,1026 iqn.1992-08.com.netapp:sn.5ec3c0ce3fab11eb8f0c005056b0a146:vs.3
192.168.0.134:3260,1029 iqn.1992-08.com.netapp:sn.5ec3c0ce3fab11eb8f0c005056b0a146:vs.3
192.168.0.133:3260,1028 iqn.1992-08.com.netapp:sn.5ec3c0ce3fab11eb8f0c005056b0a146:vs.3
192.168.0.132:3260,1027 iqn.1992-08.com.netapp:sn.5ec3c0ce3fab11eb8f0c005056b0a146:vs.3

[root@centos1 ~]# iscsiadm --mode node -l all
Logging in to [iface: default, target: iqn.1992-08.com.netapp:sn.5ec3c0ce3fab11eb8f0c005056b0a146:vs.3, portal: 192.168.0.131,3260] (multiple)
Logging in to [iface: default, target: iqn.1992-08.com.netapp:sn.5ec3c0ce3fab11eb8f0c005056b0a146:vs.3, portal: 192.168.0.134,3260] (multiple)
Logging in to [iface: default, target: iqn.1992-08.com.netapp:sn.5ec3c0ce3fab11eb8f0c005056b0a146:vs.3, portal: 192.168.0.133,3260] (multiple)
Logging in to [iface: default, target: iqn.1992-08.com.netapp:sn.5ec3c0ce3fab11eb8f0c005056b0a146:vs.3, portal: 192.168.0.132,3260] (multiple)
Login to [iface: default, target: iqn.1992-08.com.netapp:sn.5ec3c0ce3fab11eb8f0c005056b0a146:vs.3, portal: 192.168.0.131,3260] successful.
Login to [iface: default, target: iqn.1992-08.com.netapp:sn.5ec3c0ce3fab11eb8f0c005056b0a146:vs.3, portal: 192.168.0.134,3260] successful.
Login to [iface: default, target: iqn.1992-08.com.netapp:sn.5ec3c0ce3fab11eb8f0c005056b0a146:vs.3, portal: 192.168.0.133,3260] successful.
Login to [iface: default, target: iqn.1992-08.com.netapp:sn.5ec3c0ce3fab11eb8f0c005056b0a146:vs.3, portal: 192.168.0.132,3260] successful.

[root@centos1 ~]# iscsiadm --mode session
tcp: [1] 192.168.0.131:3260,1026 iqn.1992-08.com.netapp:sn.5ec3c0ce3fab11eb8f0c005056b0a146:vs.3 (non-flash)
tcp: [2] 192.168.0.134:3260,1029 iqn.1992-08.com.netapp:sn.5ec3c0ce3fab11eb8f0c005056b0a146:vs.3 (non-flash)
tcp: [3] 192.168.0.133:3260,1028 iqn.1992-08.com.netapp:sn.5ec3c0ce3fab11eb8f0c005056b0a146:vs.3 (non-flash)
tcp: [4] 192.168.0.132:3260,1027 iqn.1992-08.com.netapp:sn.5ec3c0ce3fab11eb8f0c005056b0a146:vs.3 (non-flash)

==================================================================================
DISCOVER NEW LUNS
==================================================================================
/usr/bin/rescan-scsi-bus.sh

[root@centos1 ~]# multipath -ll
3600a0980774f6a374d5d51504b697163 dm-2 NETAPP  ,LUN C-Mode
size=10G features='4 queue_if_no_path pg_init_retries 50 retain_attached_hw_handle' hwhandler='1 alua' wp=rw
|-+- policy='service-time 0' prio=50 status=active
| |- 33:0:0:0 sdb 8:16 active ready running
| `- 36:0:0:0 sde 8:64 active ready running
`-+- policy='service-time 0' prio=10 status=enabled
  |- 35:0:0:0 sdd 8:48 active ready running
  `- 34:0:0:0 sdc 8:32 active ready running

==================================================================================
DEBUG SAN ISCSI LINUX
==================================================================================

[root@centos1 ~]# sanlun lun show -p

                    ONTAP Path: SVM_SAN:/vol/LUN01/LUN01
                           LUN: 0
                      LUN Size: 10g
                       Product: cDOT
                   Host Device: 3600a0980774f6a374d5d51504b697163
              Multipath Policy: service-time 0
            Multipath Provider: Native
--------- ---------- ------- ------------ ----------------------------------------------
host      vserver
path      path       /dev/   host         vserver
state     type       node    adapter      LIF
--------- ---------- ------- ------------ ----------------------------------------------
up        primary    sdb     host33       lif_SVM_SAN_941
up        primary    sde     host36       lif_SVM_SAN_816
up        secondary  sdd     host35       lif_SVM_SAN_982
up        secondary  sdc     host34       lif_SVM_SAN_757

[root@centos1 ~]# multipath -ll
3600a0980774f6a374d5d51504b697163 dm-2 NETAPP  ,LUN C-Mode
size=10G features='4 queue_if_no_path pg_init_retries 50 retain_attached_hw_handle' hwhandler='1 alua' wp=rw
|-+- policy='service-time 0' prio=50 status=active
| |- 33:0:0:0 sdb 8:16 active ready running
| `- 36:0:0:0 sde 8:64 active ready running
`-+- policy='service-time 0' prio=10 status=enabled
  |- 35:0:0:0 sdd 8:48 active ready running
  `- 34:0:0:0 sdc 8:32 active ready running


cluster1::*> lun show /vol/LUN01/LUN01 -fields serial-hex
vserver path             serial-hex
------- ---------------- ------------------------
SVM_SAN /vol/LUN01/LUN01 774f6a374d5d51504b697163

[root@centos1 ~]# /lib/udev/scsi_id -gud /dev/sdb
3600a0980774f6a374d5d51504b697163
[root@centos1 ~]# /lib/udev/scsi_id -gud /dev/sdc
3600a0980774f6a374d5d51504b697163
[root@centos1 ~]# /lib/udev/scsi_id -gud /dev/sdd
3600a0980774f6a374d5d51504b697163
[root@centos1 ~]# /lib/udev/scsi_id -gud /dev/sde
3600a0980774f6a374d5d51504b697163
[root@centos1 ~]# /lib/udev/scsi_id -gud /dev/mapper/3600a0980774f6a374d5d51504b697163
3600a0980774f6a374d5d51504b697163

==================================================================================
Create Cluster peer Cluster1/2
==================================================================================

cluster1::> network interface create -vserver cluster1 -lif intercluster1 -address 192.168.0.115 -netmask-length 24 -home-node cluster1-01 -service-policy default-intercluster -home-port e0g -status-admin up

cluster1::> network interface create -vserver cluster1 -lif intercluster2 -address 192.168.0.116 -netmask-length 24 -home-node cluster1-02 -service-policy default-intercluster -home-port e0g -status-admin up

cluster2::> network interface create -vserver cluster2 -lif intercluster1 -address 192.168.0.117 -netmask-length 24 -home-node cluster2-01 -service-policy default-intercluster -home-port e0g -status-admin up

cluster2::> network interface create -vserver cluster2 -lif intercluster2 -address 192.168.0.118 -netmask-length 24 -home-node cluster2-02 -service-policy default-intercluster -home-port e0g -status-admin up

cluster1::> cluster peer create -address-family ipv4 -peer-addrs 192.168.0.117
Enter the passphrase:
Confirm the passphrase:
Notice: Now use the same passphrase in the "cluster peer create" command in the other cluster.

cluster2::> cluster peer create -address-family ipv4 -peer-addrs 192.168.0.115
Enter the passphrase:
Confirm the passphrase:

cluster2::> cluster peer show
Peer Cluster Name         Cluster Serial Number Availability   Authentication
------------------------- --------------------- -------------- --------------
cluster1                  1-80-000011           Available      ok

==================================================================================
CREATE SECONDARY SVM SAN
==================================================================================
cluster2::> vserver create -vserver SVM_SAN_SMBC -subtype default -rootvolume SVM_SAN_SMBC_root -rootvolume-security-style unix -language C.UTF-8 -snapshot-policy default -data-services data-iscsi -foreground true -aggregate cluster2_01_SSD_1

cluster2::> network interface create -vserver SVM_SAN_SMBC -lif SVM_SAN_SMBC_admin -service-policy default-data-files -address 192.168.0.140 -netmask-length 24 -home-node cluster2-01 -home-port e0g -firewall-policy mgmt

cluster2::> network interface create -vserver SVM_SAN_SMBC -lif SVM_SAN_SMBC_data1 -service-policy default-data-blocks -address 192.168.0.141 -netmask-length 24 -home-node cluster2-01 -home-port e0g -firewall-policy data

cluster2::> network interface create -vserver SVM_SAN_SMBC -lif SVM_SAN_SMBC_data2 -service-policy default-data-blocks -address 192.168.0.142 -netmask-length 24 -home-node cluster2-02 -home-port e0g -firewall-policy data

cluster2::> network interface create -vserver SVM_SAN_SMBC -lif SVM_SAN_SMBC_data2 -service-policy default-data-blocks -address 192.168.0.142 -netmask-length 24 -home-node cluster2-02 -home-port e0g -firewall-policy data

cluster2::> network interface create -vserver SVM_SAN_SMBC -lif SVM_SAN_SMBC_data3 -service-policy default-data-blocks -address 192.168.0.143 -netmask-length 24 -home-node cluster2-01 -home-port e0g -firewall-policy data

cluster2::> network interface create -vserver SVM_SAN_SMBC -lif SVM_SAN_SMBC_data4 -service-policy default-data-blocks -address 192.168.0.144 -netmask-length 24 -home-node cluster2-02 -home-port e0g -firewall-policy data

cluster2::> vserver iscsi create -target-alias SVM_SAN_SMBC -status-admin up

cluster2::> vserver iscsi show
           Target                           Target                       Status
Vserver    Name                             Alias                        Admin
---------- -------------------------------- ---------------------------- ------
SVM_SAN_SMBC
           iqn.1992-08.com.netapp:sn.0c284f29404b11eba106005056b0adff:vs.3
                                            SVM_SAN_SMBC                 up


cluster2::> vserver peer show
            Peer        Peer                           Peering        Remote
Vserver     Vserver     State        Peer Cluster      Applications   Vserver
----------- ----------- ------------ ----------------- -------------- ---------
SVM_SAN_SMBC
            SVM_SAN     peered       cluster1          snapmirror, flexcache
                                                                      SVM_SAN

cluster2::> igroup create centos01 -protocol mixed -ostype linux -initiator iqn.1994-05.com.redhat:centos1.demo.netapp.com



==================================================================================
INSTALL The Mediator
==================================================================================
[root@centos1 ~]# cd /var/tmp/
[root@centos1 tmp]# chmod +x ONTAP-MEDIATOR-1.2
[root@centos1 tmp]# ./ONTAP-MEDIATOR-1.2

ONTAP Mediator: Self Extracting Installer

ONTAP Mediator requires two user accounts. One for the service (netapp), and one for use by ONTAP to the mediator API (mediatoradmin).
Would you like to use the default account names: netapp + mediatoradmin? (Y(es)/n(o)): y




Enter ONTAP Mediator user account (mediatoradmin) password:

Re-Enter ONTAP Mediator user account (mediatoradmin) password:

Checking if SELinux is in enforcing mode




Checking for default Linux firewall
not running
Default Linux firewall not found. If neccessary,
allow inbound TCP connections on ports 31784 and 3260 for ONTAP Mediator on any firewall that may be in use.


###############################################################
Preparing for installation of ONTAP Mediator packages.


Do you wish to continue? Y(es)/n(o): Y


+ Installing required packages.


Loaded plugins: fastestmirror, langpacks, product-id, search-disabled-repos, subscription-manager

This system is not registered with an entitlement server. You can use subscription-manager to register.

Loading mirror speeds from cached hostfile
 * base: ewr.edge.kernel.org
 * epel: mirror.umd.edu
 * extras: mirror.es.its.nyu.edu
 * updates: centos.mirrors.hoobly.com

...

Sudo include verified
ONTAP Mediator logging enabled
+ Install successful. (Moving log to /opt/netapp/lib/ontap_mediator/log/install_20201217102536.log)
+ Note: ONTAP Mediator uses a kernel module compiled specifically for the current
        system OS. Using 'yum update' to upgrade the kernel may cause a service
        interruption.
    For more information, see /opt/netapp/lib/ontap_mediator/README

==================================================================================
DISPLAY Mediator Certificate 
==================================================================================

[root@centos1 ~]# cat /opt/netapp/lib/ontap_mediator/ontap_mediator/server_config/ca.crt
-----BEGIN CERTIFICATE-----
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
-----END CERTIFICATE----



==================================================================================
Check Security Certificate for Mediatore
==================================================================================

cluster1::> security certificate show -common-name ONTAPMediatorCA
Vserver    Serial Number   Certificate Name                       Type
---------- --------------- -------------------------------------- ------------
cluster1   EDD625857D959AC9 ONTAPMediatorCA                       server-ca
    Certificate Authority: ONTAP Mediator CA
          Expiration Date: Wed Dec 17 10:29:47 2070


cluster2::> security certificate show -common-name ONTAPMediatorCA
Vserver    Serial Number   Certificate Name                       Type
---------- --------------- -------------------------------------- ------------
cluster2   EDD625857D959AC9
                           ONTAPMediatorCA                        server-ca
    Certificate Authority: ONTAP Mediator CA
          Expiration Date: Wed Dec 17 10:29:47 2070


cluster1::> snapmirror mediator show -instance
       Mediator Uuid: 560163c7-405b-11eb-887a-005056b0ed17
 Mediator IP Address: 192.168.0.61
        Peer Cluster: cluster2
   Peer Cluster Uuid: e533aa6b-dce9-11ea-a195-005056b0b572
   Connection Status: connected
       Quorum Status: true
Health Fetch Timeout: 5
  Connection Timeout: 5

==================================================================================
MAP LUN 
==================================================================================
cluster1::> lun mapping show
Vserver    Path                                      Igroup   LUN ID  Protocol
---------- ----------------------------------------  -------  ------  --------
SVM_SAN    /vol/LUN01/LUN01                          centos01 0  mixed

cluster2::> lun mapping show
Vserver    Path                                      Igroup   LUN ID  Protocol
---------- ----------------------------------------  -------  ------  --------
SVM_SAN_SMBC
           /vol/vol_LUN01_dest/LUN01                 centos01      0  mixed


[root@centos1 ~]# iscsiadm --mode discovery --op update --type sendtargets --portal  192.168.0.141
192.168.0.141:3260,1029 iqn.1992-08.com.netapp:sn.0c284f29404b11eba106005056b0adff:vs.3
192.168.0.144:3260,1032 iqn.1992-08.com.netapp:sn.0c284f29404b11eba106005056b0adff:vs.3
192.168.0.143:3260,1031 iqn.1992-08.com.netapp:sn.0c284f29404b11eba106005056b0adff:vs.3
192.168.0.142:3260,1030 iqn.1992-08.com.netapp:sn.0c284f29404b11eba106005056b0adff:vs.3

[root@centos1 ~]# /usr/bin/rescan-scsi-bus.sh

[root@centos1 ~]# iscsiadm --mode node -l all
Logging in to [iface: default, target: iqn.1992-08.com.netapp:sn.0c284f29404b11eba106005056b0adff:vs.3, portal: 192.168.0.141,3260] (multiple)
Logging in to [iface: default, target: iqn.1992-08.com.netapp:sn.0c284f29404b11eba106005056b0adff:vs.3, portal: 192.168.0.144,3260] (multiple)
Logging in to [iface: default, target: iqn.1992-08.com.netapp:sn.0c284f29404b11eba106005056b0adff:vs.3, portal: 192.168.0.143,3260] (multiple)
Logging in to [iface: default, target: iqn.1992-08.com.netapp:sn.0c284f29404b11eba106005056b0adff:vs.3, portal: 192.168.0.142,3260] (multiple)
Login to [iface: default, target: iqn.1992-08.com.netapp:sn.0c284f29404b11eba106005056b0adff:vs.3, portal: 192.168.0.141,3260] successful.
Login to [iface: default, target: iqn.1992-08.com.netapp:sn.0c284f29404b11eba106005056b0adff:vs.3, portal: 192.168.0.144,3260] successful.
Login to [iface: default, target: iqn.1992-08.com.netapp:sn.0c284f29404b11eba106005056b0adff:vs.3, portal: 192.168.0.143,3260] successful.
Login to [iface: default, target: iqn.1992-08.com.netapp:sn.0c284f29404b11eba106005056b0adff:vs.3, portal: 192.168.0.142,3260] successful.

[root@centos1 ~]# iscsiadm -m session
tcp: [1] 192.168.0.131:3260,1026 iqn.1992-08.com.netapp:sn.5ec3c0ce3fab11eb8f0c005056b0a146:vs.3 (non-flash)
tcp: [2] 192.168.0.134:3260,1029 iqn.1992-08.com.netapp:sn.5ec3c0ce3fab11eb8f0c005056b0a146:vs.3 (non-flash)
tcp: [3] 192.168.0.133:3260,1028 iqn.1992-08.com.netapp:sn.5ec3c0ce3fab11eb8f0c005056b0a146:vs.3 (non-flash)
tcp: [4] 192.168.0.132:3260,1027 iqn.1992-08.com.netapp:sn.5ec3c0ce3fab11eb8f0c005056b0a146:vs.3 (non-flash)
tcp: [5] 192.168.0.141:3260,1029 iqn.1992-08.com.netapp:sn.0c284f29404b11eba106005056b0adff:vs.3 (non-flash)
tcp: [6] 192.168.0.144:3260,1032 iqn.1992-08.com.netapp:sn.0c284f29404b11eba106005056b0adff:vs.3 (non-flash)
tcp: [7] 192.168.0.143:3260,1031 iqn.1992-08.com.netapp:sn.0c284f29404b11eba106005056b0adff:vs.3 (non-flash)
tcp: [8] 192.168.0.142:3260,1030 iqn.1992-08.com.netapp:sn.0c284f29404b11eba106005056b0adff:vs.3 (non-flash)


[root@centos1 ~]# multipath -ll
3600a0980774f6a374d5d51504b697163 dm-2 NETAPP  ,LUN C-Mode
size=10G features='4 queue_if_no_path pg_init_retries 50 retain_attached_hw_handle' hwhandler='1 alua' wp=rw
|-+- policy='service-time 0' prio=50 status=active
| |- 33:0:0:0 sdb 8:16  active ready running
| `- 36:0:0:0 sde 8:64  active ready running
`-+- policy='service-time 0' prio=10 status=enabled
  |- 35:0:0:0 sdd 8:48  active ready running
  |- 37:0:0:0 sdf 8:80  active ready running
  |- 38:0:0:0 sdg 8:96  active ready running
  |- 40:0:0:0 sdh 8:112 active ready running
  `- 39:0:0:0 sdi 8:128 active ready running

[root@centos1 ~]# sanlun lun show -p

                    ONTAP Path: SVM_SAN:/vol/LUN01/LUN01
                           LUN: 0
                      LUN Size: 10g
                       Product: cDOT
                   Host Device: 3600a0980774f6a374d5d51504b697163
              Multipath Policy: service-time 0
            Multipath Provider: Native
--------- ---------- ------- ------------ ----------------------------------------------
host      vserver
path      path       /dev/   host         vserver
state     type       node    adapter      LIF
--------- ---------- ------- ------------ ----------------------------------------------
up        primary    sdb     host33       lif_SVM_SAN_941
up        primary    sde     host36       lif_SVM_SAN_816
up        secondary  sdd     host35       lif_SVM_SAN_982
up        secondary  sdc     host34       lif_SVM_SAN_757
up        secondary  sdf     host37       SVM_SAN_SMBC_data1
up        secondary  sdg     host38       SVM_SAN_SMBC_data4
up        secondary  sdh     host40       SVM_SAN_SMBC_data2
up        secondary  sdi     host39       SVM_SAN_SMBC_data3

[root@centos1 ~]# /lib/udev/scsi_id -gud /dev/mapper/3600a0980774f6a374d5d51504b697163
3600a0980774f6a374d5d51504b697163
[root@centos1 ~]# /lib/udev/scsi_id -gud /dev/sdb
3600a0980774f6a374d5d51504b697163
[root@centos1 ~]# /lib/udev/scsi_id -gud /dev/sde
3600a0980774f6a374d5d51504b697163
[root@centos1 ~]# /lib/udev/scsi_id -gud /dev/sdf
3600a0980774f6a374d5d51504b697163
[root@centos1 ~]# /lib/udev/scsi_id -gud /dev/sdg
3600a0980774f6a374d5d51504b697163
[root@centos1 ~]# /lib/udev/scsi_id -gud /dev/sdh
3600a0980774f6a374d5d51504b697163
[root@centos1 ~]# /lib/udev/scsi_id -gud /dev/sdi
3600a0980774f6a374d5d51504b697163
[root@centos1 ~]# /lib/udev/scsi_id -gud /dev/sdi



[root@centos1 /]# fdisk [root@centos1 /]# mkfs.ext4 /dev/mapper/3600a0980774f6a374d5d51504b697163
Usage:
 fdisk [options] <disk>    change partition table
 fdisk [options] -l <disk> list partition table(s)
 fdisk -s <partition>      give partition size(s) in blocks

Options:
 -b <size>             sector size (512, 1024, 2048 or 4096)
 -c[=<mode>]           compatible mode: 'dos' or 'nondos' (default)
 -h                    print this help text
 -u[=<unit>]           display units: 'cylinders' or 'sectors' (default)
 -v                    print program version
 -C <number>           specify the number of cylinders
 -H <number>           specify the number of heads
 -S <number>           specify the number of sectors per track

[root@centos1 /]# fdisk  /dev/mapper/3600a0980774f6a374d5d51504b697163
Welcome to fdisk (util-linux 2.23.2).

Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.

Device does not contain a recognized partition table
Building a new DOS disklabel with disk identifier 0xa8790eff.

The device presents a logical sector size that is smaller than
the physical sector size. Aligning to a physical sector (or optimal
I/O) size boundary is recommended, or performance may be impacted.

Command (m for help): n
Partition type:
   p   primary (0 primary, 0 extended, 4 free)
   e   extended
Select (default p): p
Partition number (1-4, default 1):
First sector (2048-20971519, default 2048):
Using default value 2048
Last sector, +sectors or +size{K,M,G} (2048-20971519, default 20971519):
Using default value 20971519
Partition 1 of type Linux and of size 10 GiB is set

Command (m for help): w
The partition table has been altered!

Calling ioctl() to re-read partition table.

WARNING: Re-reading the partition table failed with error 22: Invalid argument.
The kernel still uses the old table. The new table will be used at
the next reboot or after you run partprobe(8) or kpartx(8)
Syncing disks.
[root@centos1 /]# partprobe

[root@centos1 /]# mkfs.ext4 /dev/mapper/3600a0980774f6a374d5d51504b697163p1
mke2fs 1.42.9 (28-Dec-2013)
Filesystem label=
OS type: Linux
Block size=4096 (log=2)
Fragment size=4096 (log=2)
Stride=0 blocks, Stripe width=16 blocks
655360 inodes, 2621184 blocks
131059 blocks (5.00%) reserved for the super user
First data block=0
Maximum filesystem blocks=2151677952
80 block groups
32768 blocks per group, 32768 fragments per group
8192 inodes per group
Superblock backups stored on blocks:
        32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632

Allocating group tables: done
Writing inode tables: done
Creating journal (32768 blocks): done
Writing superblocks and filesystem accounting information: done
